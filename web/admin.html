<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>CardFlow - Admin Dashboard</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }

    :root {
      --bg-deep: #0a0e1a;
      --bg-dark: #0d1220;
      --bg-card: #111827;
      --glass: rgba(255, 255, 255, 0.03);
      --glass-border: rgba(255, 255, 255, 0.08);
      --cyan: #00f6ff;
      --cyan-glow: rgba(0, 246, 255, 0.2);
      --purple: #7b2ff7;
      --purple-glow: rgba(123, 47, 247, 0.2);
      --pink: #ff2e97;
      --text: #e6edf3;
      --text-muted: rgba(255, 255, 255, 0.5);
      --success: #00ff88;
      --warning: #ffaa00;
      --error: #ff4466;
    }

    body {
      font-family: 'Segoe UI', -apple-system, BlinkMacSystemFont, sans-serif;
      background: var(--bg-deep);
      color: var(--text);
      min-height: 100vh;
    }

    /* Header */
    .header {
      background: var(--glass);
      backdrop-filter: blur(20px);
      border-bottom: 1px solid var(--glass-border);
      padding: 16px 32px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      position: sticky;
      top: 0;
      z-index: 100;
    }

    .header-left {
      display: flex;
      align-items: center;
      gap: 16px;
    }

    .logo {
      font-size: 20px;
      font-weight: 700;
      background: linear-gradient(135deg, var(--cyan), var(--purple));
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .admin-badge {
      background: linear-gradient(135deg, var(--purple), var(--pink));
      padding: 4px 12px;
      border-radius: 20px;
      font-size: 11px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 1px;
    }

    .header-right {
      display: flex;
      align-items: center;
      gap: 16px;
    }

    .user-info {
      display: flex;
      align-items: center;
      gap: 12px;
      color: var(--text-muted);
      font-size: 14px;
    }

    .btn {
      padding: 10px 20px;
      border: none;
      border-radius: 8px;
      font-size: 13px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      text-decoration: none;
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }

    .btn-ghost {
      background: transparent;
      color: var(--text);
      border: 1px solid var(--glass-border);
    }

    .btn-ghost:hover {
      background: var(--glass);
      border-color: var(--cyan);
      color: var(--cyan);
    }

    /* Main content */
    .main-content {
      padding: 32px;
      max-width: 1600px;
      margin: 0 auto;
    }

    /* Stats grid */
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 20px;
      margin-bottom: 32px;
    }

    .stat-card {
      background: var(--glass);
      backdrop-filter: blur(10px);
      border: 1px solid var(--glass-border);
      border-radius: 16px;
      padding: 24px;
      position: relative;
      overflow: hidden;
      transition: all 0.3s ease;
    }

    .stat-card:hover {
      border-color: var(--cyan);
      box-shadow: 0 0 30px var(--cyan-glow);
      transform: translateY(-2px);
    }

    .stat-card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 2px;
      background: linear-gradient(90deg, var(--cyan), var(--purple));
      opacity: 0;
      transition: opacity 0.3s ease;
    }

    .stat-card:hover::before {
      opacity: 1;
    }

    .stat-icon {
      font-size: 32px;
      margin-bottom: 12px;
      filter: drop-shadow(0 0 10px var(--cyan-glow));
    }

    .stat-value {
      font-size: 36px;
      font-weight: 700;
      background: linear-gradient(135deg, var(--text), var(--cyan));
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      margin-bottom: 4px;
    }

    .stat-label {
      font-size: 12px;
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 1px;
    }

    .stat-change {
      font-size: 12px;
      margin-top: 8px;
      display: flex;
      align-items: center;
      gap: 4px;
    }

    .stat-change.positive { color: var(--success); }
    .stat-change.negative { color: var(--error); }

    /* Panels */
    .panels-grid {
      display: grid;
      grid-template-columns: 2fr 1fr;
      gap: 24px;
      margin-bottom: 32px;
    }

    @media (max-width: 1200px) {
      .panels-grid { grid-template-columns: 1fr; }
    }

    .panel {
      background: var(--glass);
      backdrop-filter: blur(10px);
      border: 1px solid var(--glass-border);
      border-radius: 16px;
      overflow: hidden;
    }

    .panel-header {
      padding: 20px 24px;
      border-bottom: 1px solid var(--glass-border);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .panel-title {
      font-size: 16px;
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .panel-title::before {
      content: '';
      width: 4px;
      height: 20px;
      background: linear-gradient(180deg, var(--cyan), var(--purple));
      border-radius: 2px;
    }

    .panel-body {
      padding: 20px 24px;
    }

    /* Users table */
    .users-table {
      width: 100%;
      border-collapse: collapse;
    }

    .users-table th,
    .users-table td {
      padding: 14px 16px;
      text-align: left;
      border-bottom: 1px solid var(--glass-border);
    }

    .users-table th {
      font-size: 11px;
      font-weight: 600;
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 1px;
    }

    .users-table tr:hover {
      background: rgba(0, 246, 255, 0.03);
    }

    .users-table td:first-child {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .user-avatar {
      width: 36px;
      height: 36px;
      border-radius: 50%;
      background: linear-gradient(135deg, var(--cyan), var(--purple));
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 600;
      font-size: 14px;
    }

    .user-name {
      font-weight: 500;
    }

    .user-email {
      font-size: 12px;
      color: var(--text-muted);
    }

    .role-badge {
      padding: 4px 10px;
      border-radius: 12px;
      font-size: 11px;
      font-weight: 600;
      text-transform: uppercase;
    }

    .role-admin {
      background: linear-gradient(135deg, var(--purple), var(--pink));
      color: #fff;
    }

    .role-user {
      background: rgba(255, 255, 255, 0.1);
      color: var(--text-muted);
    }

    .tier-badge {
      padding: 4px 10px;
      border-radius: 12px;
      font-size: 11px;
      font-weight: 600;
    }

    .tier-free { background: rgba(255, 255, 255, 0.1); color: var(--text-muted); }
    .tier-pro { background: rgba(0, 246, 255, 0.2); color: var(--cyan); }
    .tier-admin { background: rgba(123, 47, 247, 0.2); color: var(--purple); }

    /* Top users list */
    .top-users-list {
      list-style: none;
    }

    .top-user-item {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 12px 0;
      border-bottom: 1px solid var(--glass-border);
    }

    .top-user-item:last-child {
      border-bottom: none;
    }

    .top-user-info {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .top-user-rank {
      width: 24px;
      height: 24px;
      border-radius: 50%;
      background: var(--glass);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 11px;
      font-weight: 700;
      color: var(--text-muted);
    }

    .top-user-rank.gold { background: linear-gradient(135deg, #ffd700, #ff8c00); color: #000; }
    .top-user-rank.silver { background: linear-gradient(135deg, #c0c0c0, #a0a0a0); color: #000; }
    .top-user-rank.bronze { background: linear-gradient(135deg, #cd7f32, #a05d20); color: #000; }

    .top-user-stats {
      text-align: right;
    }

    .top-user-cards {
      font-weight: 600;
      color: var(--cyan);
    }

    .top-user-cost {
      font-size: 12px;
      color: var(--text-muted);
    }

    /* Chart placeholder */
    .chart-container {
      height: 200px;
      background: rgba(0, 0, 0, 0.2);
      border-radius: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      color: var(--text-muted);
      font-size: 14px;
    }

    .chart-bars {
      display: flex;
      align-items: flex-end;
      justify-content: center;
      gap: 8px;
      height: 150px;
      padding: 20px;
    }

    .chart-bar {
      width: 24px;
      background: linear-gradient(180deg, var(--cyan), var(--purple));
      border-radius: 4px 4px 0 0;
      opacity: 0.8;
      transition: all 0.3s ease;
    }

    .chart-bar:hover {
      opacity: 1;
      box-shadow: 0 0 20px var(--cyan-glow);
    }

    /* Loading state */
    .loading {
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 40px;
      color: var(--text-muted);
    }

    .spinner {
      width: 24px;
      height: 24px;
      border: 2px solid var(--glass-border);
      border-top-color: var(--cyan);
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
      margin-right: 12px;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    /* Access denied */
    .access-denied {
      text-align: center;
      padding: 80px 20px;
    }

    .access-denied-icon {
      font-size: 64px;
      margin-bottom: 24px;
      filter: drop-shadow(0 0 30px var(--error));
    }

    .access-denied h2 {
      font-size: 24px;
      margin-bottom: 12px;
      color: var(--error);
    }

    .access-denied p {
      color: var(--text-muted);
      margin-bottom: 24px;
    }

    /* Empty state */
    .empty-state {
      text-align: center;
      padding: 40px;
      color: var(--text-muted);
    }
  </style>
</head>
<body>
  <header class="header">
    <div class="header-left">
      <div class="logo">
        <span>üÉè</span>
        CARDFLOW
      </div>
      <div class="admin-badge">Admin Panel</div>
    </div>
    <div class="header-right">
      <div class="user-info">
        <span id="admin-email">Loading...</span>
      </div>
      <a href="/" class="btn btn-ghost">
        <span>‚Üê</span> Dashboard
      </a>
      <button class="btn btn-ghost" onclick="logout()">
        Logout
      </button>
    </div>
  </header>

  <main class="main-content" id="main-content">
    <div class="loading" id="loading">
      <span class="spinner"></span>
      Loading admin panel...
    </div>
  </main>

  <script>
    const API_URL = '/api';
    let token = localStorage.getItem('token');
    let user = JSON.parse(localStorage.getItem('user') || '{}');

    // Check authentication
    if (!token) {
      window.location.href = '/login';
    }

    document.getElementById('admin-email').textContent = user.email || 'Admin';

    // API call helper
    async function api(endpoint, options = {}) {
      const response = await fetch(`${API_URL}${endpoint}`, {
        ...options,
        headers: {
          'Content-Type': 'application/json',
          'Authorization': `Bearer ${token}`,
          ...options.headers
        }
      });

      if (response.status === 401 || response.status === 403) {
        if (response.status === 403) {
          showAccessDenied();
          return null;
        }
        window.location.href = '/login';
        return null;
      }

      return response.json();
    }

    function showAccessDenied() {
      document.getElementById('main-content').innerHTML = `
        <div class="access-denied">
          <div class="access-denied-icon">üö´</div>
          <h2>Access Denied</h2>
          <p>You don't have admin privileges to access this panel.</p>
          <a href="/" class="btn btn-ghost">Return to Dashboard</a>
        </div>
      `;
    }

    async function loadDashboard() {
      try {
        const [analytics, usersData] = await Promise.all([
          api('/admin/analytics'),
          api('/admin/users')
        ]);

        if (!analytics || !usersData) return;

        const { overview, dailyStats, topUsers } = analytics;
        const { users } = usersData;

        // Render dashboard
        document.getElementById('main-content').innerHTML = `
          <div class="stats-grid">
            <div class="stat-card">
              <div class="stat-icon">üë•</div>
              <div class="stat-value">${overview.totalUsers}</div>
              <div class="stat-label">Total Users</div>
              <div class="stat-change positive">
                <span>+${overview.activeUsers24h}</span> active today
              </div>
            </div>
            <div class="stat-card">
              <div class="stat-icon">üÉè</div>
              <div class="stat-value">${overview.totalCards}</div>
              <div class="stat-label">Total Cards</div>
              <div class="stat-change positive">
                <span>+${overview.cardsToday}</span> today
              </div>
            </div>
            <div class="stat-card">
              <div class="stat-icon">üí∞</div>
              <div class="stat-value">$${overview.totalCost.toFixed(2)}</div>
              <div class="stat-label">Total API Costs</div>
              <div class="stat-change">
                <span>$${overview.costToday.toFixed(2)}</span> today
              </div>
            </div>
            <div class="stat-card">
              <div class="stat-icon">üìä</div>
              <div class="stat-value">${overview.activeUsers24h}</div>
              <div class="stat-label">Active Users (24h)</div>
            </div>
          </div>

          <div class="panels-grid">
            <div class="panel">
              <div class="panel-header">
                <div class="panel-title">All Users</div>
                <span style="color: var(--text-muted); font-size: 13px;">
                  ${users.length} total
                </span>
              </div>
              <div class="panel-body" style="padding: 0; overflow-x: auto;">
                <table class="users-table">
                  <thead>
                    <tr>
                      <th>User</th>
                      <th>Role</th>
                      <th>Tier</th>
                      <th>Cards</th>
                      <th>Spent</th>
                      <th>Last Login</th>
                    </tr>
                  </thead>
                  <tbody>
                    ${users.map(u => `
                      <tr>
                        <td>
                          <div class="user-avatar">${(u.name || u.email)[0].toUpperCase()}</div>
                          <div>
                            <div class="user-name">${u.name || 'No Name'}</div>
                            <div class="user-email">${u.email}</div>
                          </div>
                        </td>
                        <td>
                          <span class="role-badge role-${u.role}">${u.role}</span>
                        </td>
                        <td>
                          <span class="tier-badge tier-${u.subscription_tier}">${u.subscription_tier}</span>
                        </td>
                        <td>${u.card_count || 0}</td>
                        <td>$${parseFloat(u.total_cost || 0).toFixed(2)}</td>
                        <td style="color: var(--text-muted); font-size: 12px;">
                          ${u.last_login_at ? new Date(u.last_login_at).toLocaleDateString() : 'Never'}
                        </td>
                      </tr>
                    `).join('')}
                  </tbody>
                </table>
              </div>
            </div>

            <div class="panel">
              <div class="panel-header">
                <div class="panel-title">Top Users</div>
              </div>
              <div class="panel-body">
                <ul class="top-users-list">
                  ${topUsers.slice(0, 5).map((u, i) => `
                    <li class="top-user-item">
                      <div class="top-user-info">
                        <div class="top-user-rank ${i === 0 ? 'gold' : i === 1 ? 'silver' : i === 2 ? 'bronze' : ''}">${i + 1}</div>
                        <div>
                          <div class="user-name">${u.name || u.email.split('@')[0]}</div>
                          <div class="user-email">${u.email}</div>
                        </div>
                      </div>
                      <div class="top-user-stats">
                        <div class="top-user-cards">${u.cards} cards</div>
                        <div class="top-user-cost">$${parseFloat(u.cost || 0).toFixed(2)}</div>
                      </div>
                    </li>
                  `).join('')}
                </ul>
                ${topUsers.length === 0 ? '<div class="empty-state">No users yet</div>' : ''}
              </div>
            </div>
          </div>

          <div class="panel">
            <div class="panel-header">
              <div class="panel-title">Usage Over Time (30 Days)</div>
            </div>
            <div class="panel-body">
              <div class="chart-bars">
                ${dailyStats.slice(-14).map(day => {
                  const maxCost = Math.max(...dailyStats.map(d => parseFloat(d.cost) || 1), 1);
                  const height = ((parseFloat(day.cost) || 0) / maxCost) * 120 + 10;
                  return `<div class="chart-bar" style="height: ${height}px;" title="${day.date}: $${parseFloat(day.cost).toFixed(2)}, ${day.operations} ops"></div>`;
                }).join('')}
                ${dailyStats.length === 0 ? '<span style="color: var(--text-muted);">No usage data yet</span>' : ''}
              </div>
            </div>
          </div>
        `;

      } catch (e) {
        console.error('Failed to load admin data:', e);
        document.getElementById('main-content').innerHTML = `
          <div class="access-denied">
            <div class="access-denied-icon">‚ö†Ô∏è</div>
            <h2>Error Loading Data</h2>
            <p>${e.message}</p>
            <button class="btn btn-ghost" onclick="location.reload()">Retry</button>
          </div>
        `;
      }
    }

    function logout() {
      localStorage.removeItem('token');
      localStorage.removeItem('user');
      window.location.href = '/login';
    }

    // Load dashboard
    loadDashboard();
  </script>
</body>
</html>
