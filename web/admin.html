<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>CardFlow - Admin Dashboard</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }

    :root {
      --bg-deep: #0a0e1a;
      --bg-dark: #0d1220;
      --bg-card: #111827;
      --glass: rgba(255, 255, 255, 0.03);
      --glass-border: rgba(255, 255, 255, 0.08);
      --cyan: #00f6ff;
      --cyan-glow: rgba(0, 246, 255, 0.2);
      --purple: #7b2ff7;
      --purple-glow: rgba(123, 47, 247, 0.2);
      --pink: #ff2e97;
      --text: #e6edf3;
      --text-muted: rgba(255, 255, 255, 0.5);
      --success: #00ff88;
      --warning: #ffaa00;
      --error: #ff4466;
    }

    body {
      font-family: 'Segoe UI', -apple-system, BlinkMacSystemFont, sans-serif;
      background: var(--bg-deep);
      color: var(--text);
      min-height: 100vh;
    }

    /* Header */
    .header {
      background: var(--glass);
      backdrop-filter: blur(20px);
      border-bottom: 1px solid var(--glass-border);
      padding: 16px 32px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      position: sticky;
      top: 0;
      z-index: 100;
    }

    .header-left {
      display: flex;
      align-items: center;
      gap: 16px;
    }

    .logo {
      font-size: 20px;
      font-weight: 700;
      background: linear-gradient(135deg, var(--cyan), var(--purple));
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .admin-badge {
      background: linear-gradient(135deg, var(--purple), var(--pink));
      padding: 4px 12px;
      border-radius: 20px;
      font-size: 11px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 1px;
    }

    .header-right {
      display: flex;
      align-items: center;
      gap: 16px;
    }

    .user-info {
      display: flex;
      align-items: center;
      gap: 12px;
      color: var(--text-muted);
      font-size: 14px;
    }

    .btn {
      padding: 10px 20px;
      border: none;
      border-radius: 8px;
      font-size: 13px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      text-decoration: none;
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }

    .btn-ghost {
      background: transparent;
      color: var(--text);
      border: 1px solid var(--glass-border);
    }

    .btn-ghost:hover {
      background: var(--glass);
      border-color: var(--cyan);
      color: var(--cyan);
    }

    /* Main content */
    .main-content {
      padding: 32px;
      max-width: 1600px;
      margin: 0 auto;
    }

    /* Stats grid */
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 20px;
      margin-bottom: 32px;
    }

    .stat-card {
      background: var(--glass);
      backdrop-filter: blur(10px);
      border: 1px solid var(--glass-border);
      border-radius: 16px;
      padding: 24px;
      position: relative;
      overflow: hidden;
      transition: all 0.3s ease;
    }

    .stat-card:hover {
      border-color: var(--cyan);
      box-shadow: 0 0 30px var(--cyan-glow);
      transform: translateY(-2px);
    }

    .stat-card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 2px;
      background: linear-gradient(90deg, var(--cyan), var(--purple));
      opacity: 0;
      transition: opacity 0.3s ease;
    }

    .stat-card:hover::before {
      opacity: 1;
    }

    .stat-icon {
      font-size: 32px;
      margin-bottom: 12px;
      filter: drop-shadow(0 0 10px var(--cyan-glow));
    }

    .stat-value {
      font-size: 36px;
      font-weight: 700;
      background: linear-gradient(135deg, var(--text), var(--cyan));
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      margin-bottom: 4px;
    }

    .stat-label {
      font-size: 12px;
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 1px;
    }

    .stat-change {
      font-size: 12px;
      margin-top: 8px;
      display: flex;
      align-items: center;
      gap: 4px;
    }

    .stat-change.positive { color: var(--success); }
    .stat-change.negative { color: var(--error); }

    /* Panels */
    .panels-grid {
      display: grid;
      grid-template-columns: 2fr 1fr;
      gap: 24px;
      margin-bottom: 32px;
    }

    @media (max-width: 1200px) {
      .panels-grid { grid-template-columns: 1fr; }
    }

    .panel {
      background: var(--glass);
      backdrop-filter: blur(10px);
      border: 1px solid var(--glass-border);
      border-radius: 16px;
      overflow: hidden;
    }

    .panel-header {
      padding: 20px 24px;
      border-bottom: 1px solid var(--glass-border);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .panel-title {
      font-size: 16px;
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .panel-title::before {
      content: '';
      width: 4px;
      height: 20px;
      background: linear-gradient(180deg, var(--cyan), var(--purple));
      border-radius: 2px;
    }

    .panel-body {
      padding: 20px 24px;
    }

    /* Users table */
    .users-table {
      width: 100%;
      border-collapse: collapse;
    }

    .users-table th,
    .users-table td {
      padding: 14px 16px;
      text-align: left;
      border-bottom: 1px solid var(--glass-border);
    }

    .users-table th {
      font-size: 11px;
      font-weight: 600;
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 1px;
    }

    .users-table tr:hover {
      background: rgba(0, 246, 255, 0.03);
    }

    .users-table td:first-child {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .user-avatar {
      width: 36px;
      height: 36px;
      border-radius: 50%;
      background: linear-gradient(135deg, var(--cyan), var(--purple));
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 600;
      font-size: 14px;
    }

    .user-name {
      font-weight: 500;
    }

    .user-email {
      font-size: 12px;
      color: var(--text-muted);
    }

    .role-badge {
      padding: 4px 10px;
      border-radius: 12px;
      font-size: 11px;
      font-weight: 600;
      text-transform: uppercase;
    }

    .role-admin {
      background: linear-gradient(135deg, var(--purple), var(--pink));
      color: #fff;
    }

    .role-user {
      background: rgba(255, 255, 255, 0.1);
      color: var(--text-muted);
    }

    .tier-badge {
      padding: 4px 10px;
      border-radius: 12px;
      font-size: 11px;
      font-weight: 600;
    }

    .tier-free { background: rgba(255, 255, 255, 0.1); color: var(--text-muted); }
    .tier-pro { background: rgba(0, 246, 255, 0.2); color: var(--cyan); }
    .tier-admin { background: rgba(123, 47, 247, 0.2); color: var(--purple); }

    /* Top users list */
    .top-users-list {
      list-style: none;
    }

    .top-user-item {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 12px 0;
      border-bottom: 1px solid var(--glass-border);
    }

    .top-user-item:last-child {
      border-bottom: none;
    }

    .top-user-info {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .top-user-rank {
      width: 24px;
      height: 24px;
      border-radius: 50%;
      background: var(--glass);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 11px;
      font-weight: 700;
      color: var(--text-muted);
    }

    .top-user-rank.gold { background: linear-gradient(135deg, #ffd700, #ff8c00); color: #000; }
    .top-user-rank.silver { background: linear-gradient(135deg, #c0c0c0, #a0a0a0); color: #000; }
    .top-user-rank.bronze { background: linear-gradient(135deg, #cd7f32, #a05d20); color: #000; }

    .top-user-stats {
      text-align: right;
    }

    .top-user-cards {
      font-weight: 600;
      color: var(--cyan);
    }

    .top-user-cost {
      font-size: 12px;
      color: var(--text-muted);
    }

    /* Chart placeholder */
    /* Scan History Styles */
    .scan-stats-row {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 16px;
      margin-bottom: 24px;
    }
    .scan-stat-box {
      background: var(--glass);
      border: 1px solid var(--glass-border);
      border-radius: 12px;
      padding: 16px;
      text-align: center;
    }
    .scan-stat-value {
      font-size: 28px;
      font-weight: 700;
      font-family: monospace;
    }
    .scan-stat-value.cost { color: #ff4466; }
    .scan-stat-value.scans { color: var(--cyan); }
    .scan-stat-value.tokens { color: var(--purple); }
    .scan-stat-label {
      font-size: 11px;
      color: var(--text-muted);
      text-transform: uppercase;
      margin-top: 4px;
    }
    .scans-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 13px;
    }
    .scans-table th {
      padding: 12px;
      text-align: left;
      font-size: 11px;
      color: var(--text-muted);
      text-transform: uppercase;
      border-bottom: 1px solid var(--glass-border);
    }
    .scans-table td {
      padding: 12px;
      border-bottom: 1px solid var(--glass-border);
    }
    .scans-table tr:hover {
      background: rgba(0, 246, 255, 0.03);
      cursor: pointer;
    }
    .source-badge {
      padding: 4px 8px;
      border-radius: 8px;
      font-size: 10px;
      font-weight: 600;
      text-transform: uppercase;
    }
    .source-batch { background: rgba(0, 246, 255, 0.15); color: var(--cyan); }
    .source-platform { background: rgba(0, 255, 136, 0.15); color: var(--success); }
    .scan-expanded {
      background: rgba(0, 0, 0, 0.3);
      padding: 20px;
    }
    .scan-images {
      display: flex;
      gap: 16px;
      margin-bottom: 16px;
    }
    .scan-image-box {
      flex: 1;
    }
    .scan-image-box img {
      width: 100%;
      max-height: 300px;
      object-fit: contain;
      background: rgba(0, 0, 0, 0.5);
      border-radius: 8px;
      border: 1px solid var(--glass-border);
    }
    .scan-image-label {
      font-size: 11px;
      color: var(--text-muted);
      text-transform: uppercase;
      margin-bottom: 8px;
    }
    .scan-card-data {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
      gap: 12px;
    }
    .scan-data-item {
      background: var(--glass);
      padding: 10px;
      border-radius: 8px;
    }
    .scan-data-label {
      font-size: 10px;
      color: var(--text-muted);
      text-transform: uppercase;
    }
    .scan-data-value {
      font-weight: 600;
      color: var(--text);
    }

    .chart-container {
      height: 200px;
      background: rgba(0, 0, 0, 0.2);
      border-radius: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      color: var(--text-muted);
      font-size: 14px;
    }

    .chart-bars {
      display: flex;
      align-items: flex-end;
      justify-content: center;
      gap: 8px;
      height: 150px;
      padding: 20px;
    }

    .chart-bar {
      width: 24px;
      background: linear-gradient(180deg, var(--cyan), var(--purple));
      border-radius: 4px 4px 0 0;
      opacity: 0.8;
      transition: all 0.3s ease;
    }

    .chart-bar:hover {
      opacity: 1;
      box-shadow: 0 0 20px var(--cyan-glow);
    }

    /* Loading state */
    .loading {
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 40px;
      color: var(--text-muted);
    }

    .spinner {
      width: 24px;
      height: 24px;
      border: 2px solid var(--glass-border);
      border-top-color: var(--cyan);
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
      margin-right: 12px;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    /* Access denied */
    .access-denied {
      text-align: center;
      padding: 80px 20px;
    }

    .access-denied-icon {
      font-size: 64px;
      margin-bottom: 24px;
      filter: drop-shadow(0 0 30px var(--error));
    }

    .access-denied h2 {
      font-size: 24px;
      margin-bottom: 12px;
      color: var(--error);
    }

    .access-denied p {
      color: var(--text-muted);
      margin-bottom: 24px;
    }

    /* Empty state */
    .empty-state {
      text-align: center;
      padding: 40px;
      color: var(--text-muted);
    }
  </style>
</head>
<body>
  <header class="header">
    <div class="header-left">
      <div class="logo">
        <span>üÉè</span>
        CARDFLOW
      </div>
      <div class="admin-badge">Admin Panel</div>
    </div>
    <div class="header-right">
      <div class="user-info">
        <span id="admin-email">Loading...</span>
      </div>
      <a href="/" class="btn btn-ghost">
        <span>‚Üê</span> Dashboard
      </a>
      <button class="btn btn-ghost" onclick="logout()">
        Logout
      </button>
    </div>
  </header>

  <main class="main-content" id="main-content">
    <div class="loading" id="loading">
      <span class="spinner"></span>
      Loading admin panel...
    </div>
  </main>

  <script>
    const API_URL = '/api';
    let token = localStorage.getItem('token');
    let user = JSON.parse(localStorage.getItem('user') || '{}');

    // Check authentication
    if (!token) {
      window.location.href = '/login';
    }

    document.getElementById('admin-email').textContent = user.email || 'Admin';

    // API call helper
    async function api(endpoint, options = {}) {
      const response = await fetch(`${API_URL}${endpoint}`, {
        ...options,
        headers: {
          'Content-Type': 'application/json',
          'Authorization': `Bearer ${token}`,
          ...options.headers
        }
      });

      if (response.status === 401 || response.status === 403) {
        if (response.status === 403) {
          showAccessDenied();
          return null;
        }
        window.location.href = '/login';
        return null;
      }

      return response.json();
    }

    function showAccessDenied() {
      document.getElementById('main-content').innerHTML = `
        <div class="access-denied">
          <div class="access-denied-icon">üö´</div>
          <h2>Access Denied</h2>
          <p>You don't have admin privileges to access this panel.</p>
          <a href="/" class="btn btn-ghost">Return to Dashboard</a>
        </div>
      `;
    }

    let expandedScanId = null;

    async function loadDashboard() {
      try {
        const [analytics, usersData, scanHistory, aiAnalytics, costOverview] = await Promise.all([
          api('/admin/analytics'),
          api('/admin/users'),
          api('/admin/scan-history?limit=50'),
          api('/admin/agent-analytics/overview').catch(() => null),
          api('/admin/costs/overview').catch(() => null)
        ]);

        if (!analytics || !usersData) return;

        const { overview, dailyStats, topUsers } = analytics;
        const { users } = usersData;
        const scans = scanHistory?.scans || [];
        const scanSummary = scanHistory?.summary || {};
        const ai = aiAnalytics || { today: {}, month: {}, allTime: {}, byProvider: [], byPlan: [] };
        const costs = costOverview || { today: [], month: [], allTime: [], grandTotal: { cost: 0, requests: 0 } };

        // Render dashboard
        document.getElementById('main-content').innerHTML = `
          <div class="stats-grid">
            <div class="stat-card">
              <div class="stat-icon">üë•</div>
              <div class="stat-value">${overview.totalUsers}</div>
              <div class="stat-label">Total Users</div>
              <div class="stat-change positive">
                <span>+${overview.activeUsers24h}</span> active today
              </div>
            </div>
            <div class="stat-card">
              <div class="stat-icon">üÉè</div>
              <div class="stat-value">${overview.totalCards}</div>
              <div class="stat-label">Total Cards</div>
              <div class="stat-change positive">
                <span>+${overview.cardsToday}</span> today
              </div>
            </div>
            <div class="stat-card">
              <div class="stat-icon">üí∞</div>
              <div class="stat-value">$${overview.totalCost.toFixed(2)}</div>
              <div class="stat-label">Total API Costs</div>
              <div class="stat-change">
                <span>$${overview.costToday.toFixed(2)}</span> today
              </div>
            </div>
            <div class="stat-card">
              <div class="stat-icon">üìä</div>
              <div class="stat-value">${overview.activeUsers24h}</div>
              <div class="stat-label">Active Users (24h)</div>
            </div>
          </div>

          <div class="panels-grid">
            <div class="panel">
              <div class="panel-header">
                <div class="panel-title">All Users</div>
                <span style="color: var(--text-muted); font-size: 13px;">
                  ${users.length} total
                </span>
              </div>
              <div class="panel-body" style="padding: 0; overflow-x: auto;">
                <table class="users-table">
                  <thead>
                    <tr>
                      <th>User</th>
                      <th>Role</th>
                      <th>Tier</th>
                      <th>Cards</th>
                      <th>Spent</th>
                      <th>Last Login</th>
                    </tr>
                  </thead>
                  <tbody>
                    ${users.map(u => `
                      <tr>
                        <td>
                          <div class="user-avatar">${(u.name || u.email)[0].toUpperCase()}</div>
                          <div>
                            <div class="user-name">${u.name || 'No Name'}</div>
                            <div class="user-email">${u.email}</div>
                          </div>
                        </td>
                        <td>
                          <span class="role-badge role-${u.role}">${u.role}</span>
                        </td>
                        <td>
                          <span class="tier-badge tier-${u.subscription_tier}">${u.subscription_tier}</span>
                        </td>
                        <td>${u.card_count || 0}</td>
                        <td>$${parseFloat(u.total_cost || 0).toFixed(2)}</td>
                        <td style="color: var(--text-muted); font-size: 12px;">
                          ${u.last_login_at ? new Date(u.last_login_at).toLocaleDateString() : 'Never'}
                        </td>
                      </tr>
                    `).join('')}
                  </tbody>
                </table>
              </div>
            </div>

            <div class="panel">
              <div class="panel-header">
                <div class="panel-title">Top Users</div>
              </div>
              <div class="panel-body">
                <ul class="top-users-list">
                  ${topUsers.slice(0, 5).map((u, i) => `
                    <li class="top-user-item">
                      <div class="top-user-info">
                        <div class="top-user-rank ${i === 0 ? 'gold' : i === 1 ? 'silver' : i === 2 ? 'bronze' : ''}">${i + 1}</div>
                        <div>
                          <div class="user-name">${u.name || u.email.split('@')[0]}</div>
                          <div class="user-email">${u.email}</div>
                        </div>
                      </div>
                      <div class="top-user-stats">
                        <div class="top-user-cards">${u.cards} cards</div>
                        <div class="top-user-cost">$${parseFloat(u.cost || 0).toFixed(2)}</div>
                      </div>
                    </li>
                  `).join('')}
                </ul>
                ${topUsers.length === 0 ? '<div class="empty-state">No users yet</div>' : ''}
              </div>
            </div>
          </div>

          <div class="panel">
            <div class="panel-header">
              <div class="panel-title">Usage Over Time (30 Days)</div>
            </div>
            <div class="panel-body">
              <div class="chart-bars">
                ${dailyStats.slice(-14).map(day => {
                  const maxCost = Math.max(...dailyStats.map(d => parseFloat(d.cost) || 1), 1);
                  const height = ((parseFloat(day.cost) || 0) / maxCost) * 120 + 10;
                  return `<div class="chart-bar" style="height: ${height}px;" title="${day.date}: $${parseFloat(day.cost).toFixed(2)}, ${day.operations} ops"></div>`;
                }).join('')}
                ${dailyStats.length === 0 ? '<span style="color: var(--text-muted);">No usage data yet</span>' : ''}
              </div>
            </div>
          </div>

          <!-- AI AGENT ANALYTICS PANEL -->
          <div class="panel" style="margin-top: 24px;">
            <div class="panel-header">
              <div class="panel-title" style="display: flex; align-items: center; gap: 8px;">
                ü§ñ AI Agent Analytics
                <span style="font-size: 10px; background: var(--success); color: #000; padding: 2px 6px; border-radius: 4px;">BETA</span>
              </div>
              <button class="btn btn-sm btn-ghost" onclick="openBetaManagement()">Manage Beta Users</button>
            </div>
            <div class="panel-body">
              <!-- AI Stats Grid -->
              <div class="scan-stats-row" style="margin-bottom: 20px;">
                <div class="scan-stat-box">
                  <div class="scan-stat-value" style="color: var(--cyan);">${ai.today?.analyses || 0}</div>
                  <div class="scan-stat-label">Analyses Today</div>
                </div>
                <div class="scan-stat-box">
                  <div class="scan-stat-value" style="color: var(--success);">$${(ai.today?.cost || 0).toFixed(4)}</div>
                  <div class="scan-stat-label">Cost Today</div>
                </div>
                <div class="scan-stat-box">
                  <div class="scan-stat-value" style="color: var(--purple);">${ai.month?.analyses || 0}</div>
                  <div class="scan-stat-label">This Month</div>
                </div>
                <div class="scan-stat-box">
                  <div class="scan-stat-value" style="color: var(--warning);">$${(ai.month?.cost || 0).toFixed(4)}</div>
                  <div class="scan-stat-label">Month Cost</div>
                </div>
                <div class="scan-stat-box">
                  <div class="scan-stat-value" style="color: var(--text);">${ai.allTime?.analyses || 0}</div>
                  <div class="scan-stat-label">All Time</div>
                </div>
                <div class="scan-stat-box">
                  <div class="scan-stat-value" style="color: var(--error);">${ai.errorRate || '0%'}</div>
                  <div class="scan-stat-label">Error Rate</div>
                </div>
              </div>

              <!-- By Provider -->
              <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
                <div>
                  <div style="font-size: 12px; color: var(--text-muted); margin-bottom: 8px;">By Provider</div>
                  <div id="ai-by-provider">${ai.byProvider?.length > 0 ? 'Loading...' : '<span style="color: var(--text-muted); font-size: 13px;">No data yet</span>'}</div>
                </div>
                <div>
                  <div style="font-size: 12px; color: var(--text-muted); margin-bottom: 8px;">By Plan</div>
                  <div id="ai-by-plan">${ai.byPlan?.length > 0 ? 'Loading...' : '<span style="color: var(--text-muted); font-size: 13px;">No data yet</span>'}</div>
                </div>
              </div>
            </div>
          </div>

          <!-- API COSTS BY PROVIDER PANEL -->
          <div class="panel" style="margin-top: 24px;">
            <div class="panel-header">
              <div class="panel-title">üí∞ API Costs by Provider</div>
              <button class="btn btn-sm btn-ghost" onclick="window.open('/api/admin/costs/export?format=csv', '_blank')">üì• Export CSV</button>
            </div>
            <div class="panel-body">
              <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 16px;">
                <!-- Today -->
                <div style="background: var(--glass); padding: 16px; border-radius: 12px;">
                  <div style="font-size: 12px; color: var(--text-muted); margin-bottom: 12px; text-transform: uppercase;">Today</div>
                  ${costs.today?.length > 0 ? costs.today.map(p => `
                    <div style="display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid var(--glass-border);">
                      <span style="text-transform: capitalize;">${p.provider || 'claude'}</span>
                      <span style="font-weight: 600; color: var(--success);">$${parseFloat(p.totalCost || 0).toFixed(4)}</span>
                    </div>
                  `).join('') : '<div style="color: var(--text-muted); font-size: 13px;">No costs today</div>'}
                  <div style="margin-top: 12px; padding-top: 8px; border-top: 1px solid var(--glass-border); display: flex; justify-content: space-between;">
                    <span style="font-weight: 600;">Total</span>
                    <span style="color: var(--cyan); font-weight: 700;">$${costs.today?.reduce((sum, p) => sum + parseFloat(p.totalCost || 0), 0).toFixed(4) || '0.0000'}</span>
                  </div>
                </div>
                <!-- Month -->
                <div style="background: var(--glass); padding: 16px; border-radius: 12px;">
                  <div style="font-size: 12px; color: var(--text-muted); margin-bottom: 12px; text-transform: uppercase;">This Month</div>
                  ${costs.month?.length > 0 ? costs.month.map(p => `
                    <div style="display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid var(--glass-border);">
                      <span style="text-transform: capitalize;">${p.provider || 'claude'}</span>
                      <span style="font-weight: 600; color: var(--success);">$${parseFloat(p.totalCost || 0).toFixed(2)}</span>
                    </div>
                  `).join('') : '<div style="color: var(--text-muted); font-size: 13px;">No costs this month</div>'}
                  <div style="margin-top: 12px; padding-top: 8px; border-top: 1px solid var(--glass-border); display: flex; justify-content: space-between;">
                    <span style="font-weight: 600;">Total</span>
                    <span style="color: var(--cyan); font-weight: 700;">$${costs.month?.reduce((sum, p) => sum + parseFloat(p.totalCost || 0), 0).toFixed(2) || '0.00'}</span>
                  </div>
                </div>
                <!-- All Time -->
                <div style="background: var(--glass); padding: 16px; border-radius: 12px;">
                  <div style="font-size: 12px; color: var(--text-muted); margin-bottom: 12px; text-transform: uppercase;">All Time</div>
                  ${costs.allTime?.length > 0 ? costs.allTime.map(p => `
                    <div style="display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid var(--glass-border);">
                      <span style="text-transform: capitalize;">${p.provider || 'claude'}</span>
                      <span style="font-weight: 600; color: var(--success);">$${parseFloat(p.totalCost || 0).toFixed(2)}</span>
                    </div>
                  `).join('') : '<div style="color: var(--text-muted); font-size: 13px;">No cost data</div>'}
                  <div style="margin-top: 12px; padding-top: 8px; border-top: 1px solid var(--glass-border); display: flex; justify-content: space-between;">
                    <span style="font-weight: 600;">Grand Total</span>
                    <span style="color: var(--error); font-weight: 700;">$${parseFloat(costs.grandTotal?.cost || 0).toFixed(2)}</span>
                  </div>
                </div>
              </div>
              <div style="margin-top: 16px; padding: 12px 16px; background: rgba(0, 246, 255, 0.1); border-radius: 8px; font-size: 13px;">
                <strong>Total API Requests:</strong> ${(costs.grandTotal?.requests || 0).toLocaleString()} |
                <strong>Avg Cost/Request:</strong> $${costs.grandTotal?.requests > 0 ? (parseFloat(costs.grandTotal?.cost || 0) / costs.grandTotal.requests).toFixed(6) : '0.000000'}
              </div>
            </div>
          </div>

          <!-- SCAN TRACKING PANEL -->
          <div class="panel" style="margin-top: 24px;">
            <div class="panel-header">
              <div class="panel-title">üîç Scan Tracking (All Users)</div>
              <span style="color: var(--text-muted); font-size: 13px;">
                Last 30 days
              </span>
            </div>
            <div class="panel-body">
              <!-- Scan Stats -->
              <div class="scan-stats-row">
                <div class="scan-stat-box">
                  <div class="scan-stat-value scans">${scanSummary.totalScans || 0}</div>
                  <div class="scan-stat-label">Total Scans</div>
                </div>
                <div class="scan-stat-box">
                  <div class="scan-stat-value cost">$${(scanSummary.totalCost || 0).toFixed(4)}</div>
                  <div class="scan-stat-label">Total Cost</div>
                </div>
                <div class="scan-stat-box">
                  <div class="scan-stat-value tokens">${(scanSummary.totalTokens || 0).toLocaleString()}</div>
                  <div class="scan-stat-label">Total Tokens</div>
                </div>
                <div class="scan-stat-box">
                  <div class="scan-stat-value" style="color: var(--warning);">$${scanSummary.avgCostPerScan || '0'}</div>
                  <div class="scan-stat-label">Avg Cost/Scan</div>
                </div>
              </div>

              <!-- Scan Breakdown -->
              <div style="display: flex; gap: 24px; margin-bottom: 20px; font-size: 13px;">
                <div>
                  <span style="color: var(--text-muted);">Batch:</span>
                  <span style="color: var(--cyan); font-weight: 600;">${scanSummary.batchScans || 0}</span>
                </div>
                <div>
                  <span style="color: var(--text-muted);">Platform:</span>
                  <span style="color: var(--success); font-weight: 600;">${scanSummary.platformScans || 0}</span>
                </div>
                <div>
                  <span style="color: var(--text-muted);">Single Image:</span>
                  <span style="color: var(--purple); font-weight: 600;">${scanSummary.singleImageScans || 0}</span>
                </div>
                <div>
                  <span style="color: var(--text-muted);">Front+Back:</span>
                  <span style="color: var(--pink); font-weight: 600;">${scanSummary.doubleImageScans || 0}</span>
                </div>
              </div>

              <!-- Scans Table -->
              <div style="overflow-x: auto;">
                <table class="scans-table" id="scans-table">
                  <thead>
                    <tr>
                      <th>Time</th>
                      <th>User</th>
                      <th>Source</th>
                      <th>Images</th>
                      <th>Cost</th>
                      <th>Tokens</th>
                      <th>Card</th>
                    </tr>
                  </thead>
                  <tbody>
                    ${scans.length === 0 ? `
                      <tr><td colspan="7" style="text-align: center; color: var(--text-muted); padding: 40px;">
                        No scans recorded yet. Scans will appear here with images and costs.
                      </td></tr>
                    ` : scans.map(scan => `
                      <tr onclick="toggleScanExpand('${scan.id}')">
                        <td style="font-family: monospace; font-size: 12px;">
                          ${new Date(scan.timestamp).toLocaleString()}
                        </td>
                        <td>
                          <div style="font-weight: 500;">${scan.full_name || 'Unknown'}</div>
                          <div style="font-size: 11px; color: var(--text-muted);">${scan.email || ''}</div>
                        </td>
                        <td>
                          <span class="source-badge source-${scan.metadata?.scan_source || 'platform'}">
                            ${scan.metadata?.scan_source || 'platform'}
                          </span>
                        </td>
                        <td style="text-align: center; font-weight: 600; color: var(--purple);">
                          ${scan.metadata?.image_count || 1}
                        </td>
                        <td style="font-family: monospace; color: #ff4466; font-weight: 600;">
                          $${parseFloat(scan.cost || 0).toFixed(6)}
                        </td>
                        <td style="font-family: monospace; color: var(--cyan);">
                          ${((scan.tokens_input || 0) + (scan.tokens_output || 0)).toLocaleString()}
                        </td>
                        <td style="max-width: 200px; overflow: hidden; text-overflow: ellipsis;">
                          ${scan.metadata?.card_data?.player || '-'}
                        </td>
                      </tr>
                      <tr id="scan-expand-${scan.id}" style="display: none;">
                        <td colspan="7" class="scan-expanded">
                          <div class="scan-images">
                            ${scan.metadata?.front_image ? `
                              <div class="scan-image-box">
                                <div class="scan-image-label">Front</div>
                                <img src="${scan.metadata.front_image}" alt="Front" />
                              </div>
                            ` : ''}
                            ${scan.metadata?.back_image ? `
                              <div class="scan-image-box">
                                <div class="scan-image-label">Back</div>
                                <img src="${scan.metadata.back_image}" alt="Back" />
                              </div>
                            ` : ''}
                          </div>
                          ${scan.metadata?.card_data ? `
                            <div class="scan-card-data">
                              <div class="scan-data-item">
                                <div class="scan-data-label">Player</div>
                                <div class="scan-data-value">${scan.metadata.card_data.player || '-'}</div>
                              </div>
                              <div class="scan-data-item">
                                <div class="scan-data-label">Year</div>
                                <div class="scan-data-value">${scan.metadata.card_data.year || '-'}</div>
                              </div>
                              <div class="scan-data-item">
                                <div class="scan-data-label">Set</div>
                                <div class="scan-data-value">${scan.metadata.card_data.set_name || '-'}</div>
                              </div>
                              <div class="scan-data-item">
                                <div class="scan-data-label">Card #</div>
                                <div class="scan-data-value">${scan.metadata.card_data.card_number || '-'}</div>
                              </div>
                              <div class="scan-data-item">
                                <div class="scan-data-label">Parallel</div>
                                <div class="scan-data-value">${scan.metadata.card_data.parallel || 'Base'}</div>
                              </div>
                              <div class="scan-data-item">
                                <div class="scan-data-label">Sport</div>
                                <div class="scan-data-value">${scan.metadata.card_data.sport || '-'}</div>
                              </div>
                              ${scan.metadata.card_data.is_graded ? `
                                <div class="scan-data-item">
                                  <div class="scan-data-label">Grade</div>
                                  <div class="scan-data-value">${scan.metadata.card_data.grading_company} ${scan.metadata.card_data.grade}</div>
                                </div>
                              ` : ''}
                            </div>
                          ` : '<div style="color: var(--text-muted);">No card data</div>'}
                        </td>
                      </tr>
                    `).join('')}
                  </tbody>
                </table>
              </div>
            </div>
          </div>
        `;

        // Populate AI analytics data after DOM is ready
        setTimeout(() => {
          const providerEl = document.getElementById('ai-by-provider');
          const planEl = document.getElementById('ai-by-plan');

          if (providerEl && ai.byProvider?.length > 0) {
            providerEl.innerHTML = ai.byProvider.map(p =>
              '<div style="display: flex; justify-content: space-between; padding: 8px 12px; background: var(--glass); border-radius: 6px; margin-bottom: 6px;">' +
              '<span style="text-transform: capitalize;">' + (p.ai_provider || 'Unknown') + '</span>' +
              '<span>' + p.count + ' ($' + parseFloat(p.cost || 0).toFixed(4) + ')</span>' +
              '</div>'
            ).join('');
          }

          if (planEl && ai.byPlan?.length > 0) {
            planEl.innerHTML = ai.byPlan.map(p =>
              '<div style="display: flex; justify-content: space-between; padding: 8px 12px; background: var(--glass); border-radius: 6px; margin-bottom: 6px;">' +
              '<span style="text-transform: capitalize;">' + (p.plan || 'Free') + '</span>' +
              '<span>' + p.count + ' ($' + parseFloat(p.cost || 0).toFixed(4) + ')</span>' +
              '</div>'
            ).join('');
          }
        }, 0);

      } catch (e) {
        console.error('Failed to load admin data:', e);
        document.getElementById('main-content').innerHTML = `
          <div class="access-denied">
            <div class="access-denied-icon">‚ö†Ô∏è</div>
            <h2>Error Loading Data</h2>
            <p>${e.message}</p>
            <button class="btn btn-ghost" onclick="location.reload()">Retry</button>
          </div>
        `;
      }
    }

    function logout() {
      localStorage.removeItem('token');
      localStorage.removeItem('user');
      window.location.href = '/login';
    }

    function toggleScanExpand(scanId) {
      const row = document.getElementById(`scan-expand-${scanId}`);
      if (!row) return;

      if (expandedScanId === scanId) {
        row.style.display = 'none';
        expandedScanId = null;
      } else {
        // Close previously expanded
        if (expandedScanId) {
          const prev = document.getElementById(`scan-expand-${expandedScanId}`);
          if (prev) prev.style.display = 'none';
        }
        row.style.display = 'table-row';
        expandedScanId = scanId;
      }
    }

    // ============================================
    // AI BETA MANAGEMENT
    // ============================================

    let betaModalOpen = false;

    async function openBetaManagement() {
      betaModalOpen = true;

      // Create modal if doesn't exist
      if (!document.getElementById('beta-modal')) {
        const modalHtml = `
          <div class="modal open" id="beta-modal" style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.8); display: flex; align-items: center; justify-content: center; z-index: 1000;">
            <div style="background: var(--bg-card); border-radius: 16px; max-width: 600px; width: 90%; max-height: 80vh; overflow: hidden;">
              <div style="padding: 20px 24px; border-bottom: 1px solid var(--glass-border); display: flex; justify-content: space-between; align-items: center;">
                <h2 style="font-size: 18px;">ü§ñ AI Beta Management</h2>
                <button onclick="closeBetaModal()" style="background: none; border: none; color: var(--text); font-size: 24px; cursor: pointer;">&times;</button>
              </div>
              <div style="padding: 24px; max-height: 60vh; overflow-y: auto;" id="beta-users-list">
                Loading users...
              </div>
            </div>
          </div>
        `;
        document.body.insertAdjacentHTML('beforeend', modalHtml);
      } else {
        document.getElementById('beta-modal').classList.add('open');
        document.getElementById('beta-modal').style.display = 'flex';
      }

      await loadBetaUsers();
    }

    function closeBetaModal() {
      const modal = document.getElementById('beta-modal');
      if (modal) {
        modal.style.display = 'none';
      }
      betaModalOpen = false;
    }

    async function loadBetaUsers() {
      try {
        const usersData = await api('/admin/users');
        const aiUsers = await api('/admin/agent-analytics/users').catch(() => ({ users: [] }));

        const users = usersData?.users || [];
        const aiUserMap = new Map((aiUsers.users || []).map(u => [u.id, u]));

        let tableRows = '';
        users.forEach(u => {
          const aiData = aiUserMap.get(u.id) || {};
          const betaEnabled = u.beta_features?.agentAnalysis || false;
          tableRows += `
            <tr style="border-bottom: 1px solid var(--glass-border);">
              <td style="padding: 12px 8px;">
                <div style="font-weight: 500;">${u.name || u.email.split('@')[0]}</div>
                <div style="font-size: 11px; color: var(--text-muted);">${u.email}</div>
              </td>
              <td style="text-align: center; padding: 12px 8px;">
                <span style="color: ${betaEnabled ? 'var(--success)' : 'var(--text-muted)'};">
                  ${betaEnabled ? '‚úì Enabled' : '‚óã Disabled'}
                </span>
              </td>
              <td style="text-align: center; padding: 12px 8px;">
                ${u.agent_analyses_limit || 3}
              </td>
              <td style="text-align: center; padding: 12px 8px;">
                ${u.agent_analyses_used || 0}
              </td>
              <td style="text-align: center; padding: 12px 8px;">
                <button onclick="toggleBeta('${u.id}', ${!betaEnabled})" class="btn btn-sm" style="background: ${betaEnabled ? 'var(--error)' : 'var(--success)'}; color: white; padding: 6px 12px; font-size: 11px;">
                  ${betaEnabled ? 'Disable' : 'Enable'}
                </button>
                <button onclick="setUserLimit('${u.id}')" class="btn btn-sm btn-ghost" style="padding: 6px 12px; font-size: 11px;">
                  Set Limit
                </button>
              </td>
            </tr>
          `;
        });

        document.getElementById('beta-users-list').innerHTML = `
          <div style="margin-bottom: 16px;">
            <div style="font-size: 13px; color: var(--text-muted); margin-bottom: 12px;">
              Enable AI Analysis beta for users. They'll need to provide their own API key.
            </div>
          </div>
          <table style="width: 100%; border-collapse: collapse;">
            <thead>
              <tr style="font-size: 11px; color: var(--text-muted); text-transform: uppercase;">
                <th style="text-align: left; padding: 8px;">User</th>
                <th style="text-align: center; padding: 8px;">Beta</th>
                <th style="text-align: center; padding: 8px;">Limit</th>
                <th style="text-align: center; padding: 8px;">Used</th>
                <th style="text-align: center; padding: 8px;">Actions</th>
              </tr>
            </thead>
            <tbody>
              ${tableRows}
            </tbody>
          </table>
        `;
      } catch (e) {
        document.getElementById('beta-users-list').innerHTML = `
          <div style="color: var(--error);">Failed to load users: ${e.message}</div>
        `;
      }
    }

    async function toggleBeta(userId, enabled) {
      try {
        const response = await fetch(`${API_URL}/admin/agent-analytics/enable-beta`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${token}`
          },
          body: JSON.stringify({ userId, enabled })
        });

        const data = await response.json();
        if (data.success) {
          await loadBetaUsers();
        } else {
          alert('Failed: ' + data.error);
        }
      } catch (e) {
        alert('Error: ' + e.message);
      }
    }

    async function setUserLimit(userId) {
      const limit = prompt('Set monthly analysis limit for this user:', '50');
      if (limit === null) return;

      const limitNum = parseInt(limit);
      if (isNaN(limitNum) || limitNum < 0) {
        alert('Please enter a valid number');
        return;
      }

      try {
        const response = await fetch(`${API_URL}/admin/agent-analytics/enable-beta`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${token}`
          },
          body: JSON.stringify({ userId, enabled: true, limit: limitNum })
        });

        const data = await response.json();
        if (data.success) {
          await loadBetaUsers();
        } else {
          alert('Failed: ' + data.error);
        }
      } catch (e) {
        alert('Error: ' + e.message);
      }
    }

    // Load dashboard
    loadDashboard();
  </script>
</body>
</html>
