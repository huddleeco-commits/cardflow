<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>CardFlow - Collection</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }

    :root {
      --bg-deep: #0a0e1a;
      --bg-dark: #0d1220;
      --bg-card: #111827;
      --glass: rgba(255, 255, 255, 0.03);
      --glass-hover: rgba(255, 255, 255, 0.06);
      --glass-border: rgba(255, 255, 255, 0.08);
      --cyan: #00f6ff;
      --cyan-dim: #00b8c4;
      --cyan-glow: rgba(0, 246, 255, 0.15);
      --purple: #7b2ff7;
      --purple-glow: rgba(123, 47, 247, 0.15);
      --pink: #ff2e97;
      --text: #e6edf3;
      --text-muted: rgba(255, 255, 255, 0.5);
      --success: #00ff88;
      --success-glow: rgba(0, 255, 136, 0.2);
      --warning: #ffaa00;
      --error: #ff4466;
    }

    body {
      font-family: 'Segoe UI', -apple-system, BlinkMacSystemFont, sans-serif;
      background: var(--bg-deep);
      color: var(--text);
      min-height: 100vh;
    }

    /* Header */
    .header {
      background: var(--glass);
      backdrop-filter: blur(20px);
      border-bottom: 1px solid var(--glass-border);
      padding: 12px 24px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      position: sticky;
      top: 0;
      z-index: 100;
    }

    .header-left {
      display: flex;
      align-items: center;
      gap: 24px;
    }

    .logo {
      display: flex;
      align-items: center;
      gap: 10px;
      font-size: 20px;
      font-weight: 700;
      text-decoration: none;
    }

    .logo-text {
      background: linear-gradient(135deg, var(--cyan), var(--purple));
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
    }

    .nav-links {
      display: flex;
      gap: 8px;
    }

    .nav-links a {
      padding: 8px 16px;
      color: var(--text-muted);
      text-decoration: none;
      border-radius: 8px;
      font-size: 14px;
      transition: all 0.2s;
    }

    .nav-links a:hover {
      color: var(--text);
      background: var(--glass);
    }

    .nav-links a.active {
      color: var(--cyan);
      background: var(--glass);
    }

    .header-stats {
      display: flex;
      gap: 32px;
    }

    .stat {
      text-align: center;
    }

    .stat-value {
      font-size: 24px;
      font-weight: 700;
      background: linear-gradient(135deg, var(--text), var(--cyan));
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
    }

    .stat-value.money {
      background: linear-gradient(135deg, var(--success), var(--cyan));
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
    }

    .stat-label {
      font-size: 10px;
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 1px;
    }

    /* Toolbar */
    .toolbar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 16px 24px;
      background: var(--glass);
      border-bottom: 1px solid var(--glass-border);
      gap: 16px;
      flex-wrap: wrap;
    }

    .toolbar-left {
      display: flex;
      align-items: center;
      gap: 12px;
      flex-wrap: wrap;
    }

    .toolbar-right {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .search-box {
      display: flex;
      align-items: center;
      background: var(--bg-deep);
      border: 1px solid var(--glass-border);
      border-radius: 8px;
      padding: 0 12px;
    }

    .search-box input {
      background: none;
      border: none;
      padding: 10px 8px;
      color: var(--text);
      font-size: 14px;
      width: 250px;
      outline: none;
    }

    .search-box input::placeholder {
      color: var(--text-muted);
    }

    select {
      padding: 10px 16px;
      background: var(--bg-deep);
      border: 1px solid var(--glass-border);
      border-radius: 8px;
      color: var(--text);
      font-size: 13px;
      cursor: pointer;
    }

    select:focus {
      border-color: var(--cyan);
      outline: none;
    }

    .btn {
      padding: 10px 20px;
      border: none;
      border-radius: 8px;
      font-size: 13px;
      font-weight: 600;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 8px;
      transition: all 0.2s;
    }

    .btn-primary {
      background: linear-gradient(135deg, var(--cyan), var(--cyan-dim));
      color: #000;
    }

    .btn-primary:hover {
      box-shadow: 0 0 20px var(--cyan-glow);
    }

    .btn-success {
      background: linear-gradient(135deg, var(--success), #00cc6a);
      color: #000;
    }

    .btn-accent {
      background: linear-gradient(135deg, var(--purple), var(--cyan));
      color: #fff;
    }

    .btn-secondary {
      background: var(--glass);
      border: 1px solid var(--glass-border);
      color: var(--text);
    }

    .btn-danger {
      background: linear-gradient(135deg, var(--error), #cc3355);
      color: #fff;
    }

    .btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    /* Selection Bar */
    .selection-bar {
      display: none;
      align-items: center;
      gap: 16px;
      padding: 12px 24px;
      background: linear-gradient(135deg, var(--purple-glow), var(--cyan-glow));
      border-bottom: 1px solid var(--glass-border);
    }

    .selection-bar.visible {
      display: flex;
    }

    .selection-count {
      font-weight: 600;
      color: var(--cyan);
    }

    /* Grid */
    .collection-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
      gap: 16px;
      padding: 24px;
    }

    .card-item {
      background: var(--bg-card);
      border: 1px solid var(--glass-border);
      border-radius: 12px;
      overflow: hidden;
      transition: all 0.2s;
      position: relative;
      cursor: pointer;
    }

    .card-item:hover {
      border-color: var(--cyan);
      transform: translateY(-2px);
      box-shadow: 0 8px 30px var(--cyan-glow);
    }

    .card-item.selected {
      border-color: var(--purple);
      box-shadow: 0 0 20px var(--purple-glow);
    }

    .card-checkbox {
      position: absolute;
      top: 8px;
      left: 8px;
      width: 24px;
      height: 24px;
      background: rgba(0,0,0,0.7);
      border: 2px solid var(--glass-border);
      border-radius: 6px;
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 10;
      cursor: pointer;
      transition: all 0.2s;
    }

    .card-checkbox:hover {
      border-color: var(--cyan);
    }

    .card-item.selected .card-checkbox {
      background: var(--purple);
      border-color: var(--purple);
    }

    .card-checkbox::after {
      content: '';
      display: none;
    }

    .card-item.selected .card-checkbox::after {
      content: '‚úì';
      display: block;
      color: #fff;
      font-weight: bold;
      font-size: 14px;
    }

    .card-image {
      width: 100%;
      aspect-ratio: 3/4;
      object-fit: cover;
      background: var(--bg-deep);
    }

    .card-info {
      padding: 12px;
    }

    .card-player {
      font-weight: 600;
      font-size: 14px;
      margin-bottom: 4px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .card-set {
      font-size: 12px;
      color: var(--text-muted);
      margin-bottom: 8px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .card-footer {
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .card-price {
      font-size: 16px;
      font-weight: 700;
      color: var(--success);
    }

    .card-status {
      font-size: 10px;
      padding: 4px 8px;
      border-radius: 4px;
      text-transform: uppercase;
      font-weight: 600;
    }

    .status-priced {
      background: rgba(0, 255, 136, 0.15);
      color: var(--success);
    }

    .status-identified {
      background: rgba(0, 246, 255, 0.15);
      color: var(--cyan);
    }

    .status-listed {
      background: rgba(123, 47, 247, 0.15);
      color: var(--purple);
    }

    .status-pending {
      background: rgba(255, 170, 0, 0.15);
      color: var(--warning);
    }

    /* Empty State */
    .empty-state {
      text-align: center;
      padding: 80px 20px;
      grid-column: 1 / -1;
    }

    .empty-icon {
      font-size: 64px;
      margin-bottom: 16px;
    }

    .empty-state h3 {
      font-size: 20px;
      margin-bottom: 8px;
    }

    .empty-state p {
      color: var(--text-muted);
    }

    /* Toast */
    .toast {
      position: fixed;
      bottom: 24px;
      right: 24px;
      padding: 16px 24px;
      background: var(--bg-card);
      border: 1px solid var(--glass-border);
      border-radius: 12px;
      display: flex;
      align-items: center;
      gap: 12px;
      z-index: 1000;
      animation: slideIn 0.3s ease;
    }

    .toast.success { border-color: var(--success); }
    .toast.error { border-color: var(--error); }

    @keyframes slideIn {
      from { transform: translateX(100%); opacity: 0; }
      to { transform: translateX(0); opacity: 1; }
    }

    /* View toggle */
    .view-toggle {
      display: flex;
      background: var(--bg-deep);
      border: 1px solid var(--glass-border);
      border-radius: 8px;
      overflow: hidden;
    }

    .view-toggle button {
      padding: 8px 12px;
      background: none;
      border: none;
      color: var(--text-muted);
      cursor: pointer;
      font-size: 16px;
    }

    .view-toggle button.active {
      background: var(--glass);
      color: var(--cyan);
    }

    /* List view */
    .collection-grid.list-view {
      grid-template-columns: 1fr;
    }

    .collection-grid.list-view .card-item {
      display: flex;
      flex-direction: row;
    }

    .collection-grid.list-view .card-image {
      width: 80px;
      height: 110px;
      aspect-ratio: auto;
    }

    .collection-grid.list-view .card-info {
      flex: 1;
      display: flex;
      align-items: center;
      gap: 24px;
    }

    .collection-grid.list-view .card-player {
      min-width: 200px;
    }

    .collection-grid.list-view .card-set {
      min-width: 200px;
      margin-bottom: 0;
    }

    .collection-grid.list-view .card-footer {
      margin-left: auto;
    }
  </style>
</head>
<body>
  <!-- Header -->
  <header class="header">
    <div class="header-left">
      <a href="/" class="logo">
        <span style="font-size: 28px;">üÉè</span>
        <span class="logo-text">CARDFLOW</span>
      </a>
      <nav class="nav-links">
        <a href="/">Dashboard</a>
        <a href="/collection" class="active">Collection</a>
      </nav>
    </div>
    <div class="header-stats">
      <div class="stat">
        <div class="stat-value" id="total-cards">0</div>
        <div class="stat-label">Cards</div>
      </div>
      <div class="stat">
        <div class="stat-value money" id="total-value">$0</div>
        <div class="stat-label">Value</div>
      </div>
      <div class="stat">
        <div class="stat-value" id="listed-count">0</div>
        <div class="stat-label">Listed</div>
      </div>
    </div>
  </header>

  <!-- Toolbar -->
  <div class="toolbar">
    <div class="toolbar-left">
      <div class="search-box">
        <span>üîç</span>
        <input type="text" id="search-input" placeholder="Search player, set, year..." onkeyup="filterCards()">
      </div>
      <select id="status-filter" onchange="filterCards()">
        <option value="">All Status</option>
        <option value="pending">Pending</option>
        <option value="identified">Identified</option>
        <option value="priced">Priced</option>
        <option value="listed">Listed</option>
      </select>
      <select id="sport-filter" onchange="filterCards()">
        <option value="">All Sports</option>
        <option value="Baseball">Baseball</option>
        <option value="Basketball">Basketball</option>
        <option value="Football">Football</option>
        <option value="Hockey">Hockey</option>
        <option value="Soccer">Soccer</option>
        <option value="Pokemon">Pokemon</option>
      </select>
      <select id="sort-by" onchange="sortCards()">
        <option value="recent">Recently Added</option>
        <option value="value-high">Value: High to Low</option>
        <option value="value-low">Value: Low to High</option>
        <option value="player-az">Player: A-Z</option>
        <option value="player-za">Player: Z-A</option>
        <option value="year-new">Year: Newest</option>
        <option value="year-old">Year: Oldest</option>
      </select>
    </div>
    <div class="toolbar-right">
      <div class="view-toggle">
        <button id="view-grid" class="active" onclick="setView('grid')">‚ñ¶</button>
        <button id="view-list" onclick="setView('list')">‚ò∞</button>
      </div>
      <button class="btn btn-secondary" onclick="selectAll()">‚òë Select All</button>
      <button class="btn btn-primary" onclick="window.location.href='/'">+ Add Cards</button>
    </div>
  </div>

  <!-- Selection Bar -->
  <div class="selection-bar" id="selection-bar">
    <span class="selection-count"><span id="selected-count">0</span> cards selected</span>
    <button class="btn btn-success" onclick="bulkListSelected()">üì¶ Bulk List</button>
    <button class="btn btn-accent" onclick="createLotFromSelected()">üé¥ Create Lot</button>
    <button class="btn btn-secondary" onclick="searchSelectedPrices()">üîç Price Check</button>
    <button class="btn btn-danger" onclick="deleteSelected()">üóëÔ∏è Delete</button>
    <button class="btn btn-secondary" onclick="clearSelection()">‚úï Clear</button>
  </div>

  <!-- Collection Grid -->
  <div class="collection-grid" id="collection-grid">
    <!-- Cards loaded here -->
  </div>

  <script>
    const API_URL = '/api';
    let cards = [];
    let filteredCards = [];
    let selectedIds = new Set();
    let token = localStorage.getItem('token');
    let currentView = 'grid';

    if (!token) {
      window.location.href = '/login';
    }

    async function api(endpoint, options = {}) {
      const response = await fetch(`${API_URL}${endpoint}`, {
        ...options,
        headers: {
          'Content-Type': 'application/json',
          'Authorization': `Bearer ${token}`,
          ...options.headers
        }
      });

      if (response.status === 401 || response.status === 403) {
        localStorage.removeItem('token');
        window.location.href = '/login';
        return null;
      }

      return response.json();
    }

    async function loadCards() {
      const data = await api('/cards');
      if (!data) return;

      cards = data.cards.map(card => ({
        id: card.id,
        player: card.player || 'Unknown',
        year: card.year || '',
        set_name: card.set_name || '',
        sport: card.sport || '',
        status: card.status,
        price: card.recommended_price || null,
        front: card.front,
        is_graded: card.is_graded,
        grading_company: card.grading_company,
        grade: card.grade,
        created_at: card.created_at
      }));

      filteredCards = [...cards];
      updateStats();
      renderCards();
    }

    function updateStats() {
      const total = cards.length;
      const value = cards.reduce((sum, c) => sum + (c.price || 0), 0);
      const listed = cards.filter(c => c.status === 'listed').length;

      document.getElementById('total-cards').textContent = total;
      document.getElementById('total-value').textContent = '$' + value.toFixed(2);
      document.getElementById('listed-count').textContent = listed;
    }

    function getCardFolder(status) {
      switch (status) {
        case 'pending': return '1-new';
        case 'identified':
        case 'approved':
        case 'priced': return '2-identified';
        case 'listed':
        case 'exported': return '4-exported';
        default: return '2-identified';
      }
    }

    function renderCards() {
      const grid = document.getElementById('collection-grid');

      if (filteredCards.length === 0) {
        grid.innerHTML = `
          <div class="empty-state">
            <div class="empty-icon">üÉè</div>
            <h3>No cards found</h3>
            <p>Upload cards from the dashboard to get started</p>
          </div>
        `;
        return;
      }

      grid.innerHTML = filteredCards.map(card => {
        const folder = getCardFolder(card.status);
        const imgSrc = card.front ? `/images/${folder}/${card.front}` : '';
        const isSelected = selectedIds.has(card.id);

        return `
          <div class="card-item ${isSelected ? 'selected' : ''}" data-id="${card.id}" onclick="toggleSelect('${card.id}', event)">
            <div class="card-checkbox" onclick="toggleSelect('${card.id}', event)"></div>
            ${imgSrc ? `<img class="card-image" src="${imgSrc}" alt="${card.player}" loading="lazy">` : '<div class="card-image"></div>'}
            <div class="card-info">
              <div class="card-player">${card.player}</div>
              <div class="card-set">${card.year} ${card.set_name}</div>
              <div class="card-footer">
                <span class="card-price">${card.price ? '$' + card.price.toFixed(2) : '-'}</span>
                <span class="card-status status-${card.status}">${card.status}</span>
              </div>
            </div>
          </div>
        `;
      }).join('');
    }

    function toggleSelect(id, event) {
      event.stopPropagation();

      if (selectedIds.has(id)) {
        selectedIds.delete(id);
      } else {
        selectedIds.add(id);
      }

      updateSelectionUI();
      renderCards();
    }

    function updateSelectionUI() {
      const bar = document.getElementById('selection-bar');
      const count = document.getElementById('selected-count');

      if (selectedIds.size > 0) {
        bar.classList.add('visible');
        count.textContent = selectedIds.size;
      } else {
        bar.classList.remove('visible');
      }
    }

    function selectAll() {
      if (selectedIds.size === filteredCards.length) {
        selectedIds.clear();
      } else {
        filteredCards.forEach(c => selectedIds.add(c.id));
      }
      updateSelectionUI();
      renderCards();
    }

    function clearSelection() {
      selectedIds.clear();
      updateSelectionUI();
      renderCards();
    }

    function filterCards() {
      const search = document.getElementById('search-input').value.toLowerCase();
      const status = document.getElementById('status-filter').value;
      const sport = document.getElementById('sport-filter').value;

      filteredCards = cards.filter(card => {
        const matchesSearch = !search ||
          card.player.toLowerCase().includes(search) ||
          card.set_name.toLowerCase().includes(search) ||
          String(card.year).includes(search);

        const matchesStatus = !status || card.status === status;
        const matchesSport = !sport || card.sport === sport;

        return matchesSearch && matchesStatus && matchesSport;
      });

      sortCards();
    }

    function sortCards() {
      const sortBy = document.getElementById('sort-by').value;

      filteredCards.sort((a, b) => {
        switch (sortBy) {
          case 'value-high':
            return (b.price || 0) - (a.price || 0);
          case 'value-low':
            return (a.price || 0) - (b.price || 0);
          case 'player-az':
            return a.player.localeCompare(b.player);
          case 'player-za':
            return b.player.localeCompare(a.player);
          case 'year-new':
            return (b.year || 0) - (a.year || 0);
          case 'year-old':
            return (a.year || 0) - (b.year || 0);
          case 'recent':
          default:
            return new Date(b.created_at) - new Date(a.created_at);
        }
      });

      renderCards();
    }

    function setView(view) {
      currentView = view;
      const grid = document.getElementById('collection-grid');
      grid.classList.toggle('list-view', view === 'list');
      document.getElementById('view-grid').classList.toggle('active', view === 'grid');
      document.getElementById('view-list').classList.toggle('active', view === 'list');
    }

    async function bulkListSelected() {
      if (selectedIds.size === 0) {
        showToast('No cards selected', 'error');
        return;
      }

      const selected = cards.filter(c => selectedIds.has(c.id) && c.status === 'priced' && c.price);
      if (selected.length === 0) {
        showToast('No priced cards selected', 'error');
        return;
      }

      // Redirect to main dashboard with bulk listing
      localStorage.setItem('bulkListIds', JSON.stringify([...selectedIds]));
      window.location.href = '/?action=bulk-list';
    }

    async function createLotFromSelected() {
      if (selectedIds.size < 2) {
        showToast('Select at least 2 cards for a lot', 'error');
        return;
      }

      localStorage.setItem('lotCardIds', JSON.stringify([...selectedIds]));
      window.location.href = '/?action=create-lot';
    }

    function searchSelectedPrices() {
      if (selectedIds.size === 0) {
        showToast('No cards selected', 'error');
        return;
      }

      // Get first selected card and search
      const card = cards.find(c => selectedIds.has(c.id));
      if (card) {
        const query = `${card.year} ${card.set_name} ${card.player}`.trim();
        const q = encodeURIComponent(query);

        // Open eBay sold in new tab
        window.open(`https://www.ebay.com/sch/i.html?_nkw=${q}&LH_Complete=1&LH_Sold=1&_sop=13`, '_blank');
      }
    }

    async function deleteSelected() {
      if (selectedIds.size === 0) return;

      if (!confirm(`Delete ${selectedIds.size} cards? This cannot be undone.`)) return;

      for (const id of selectedIds) {
        await api(`/cards/${id}`, { method: 'DELETE' });
      }

      showToast(`Deleted ${selectedIds.size} cards`, 'success');
      selectedIds.clear();
      loadCards();
    }

    function showToast(message, type = 'success') {
      const existing = document.querySelector('.toast');
      if (existing) existing.remove();

      const toast = document.createElement('div');
      toast.className = `toast ${type}`;
      toast.innerHTML = `<span>${type === 'success' ? '‚úì' : '‚ö†'}</span><span>${message}</span>`;
      document.body.appendChild(toast);

      setTimeout(() => toast.remove(), 3000);
    }

    // Initialize
    loadCards();
  </script>
</body>
</html>
